<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LMSR Two Condition Simulator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Source+Code+Pro:wght@500&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
        }
        .control-label, .value-display, .info-box h2, .tab-button {
            font-family: 'Source Code Pro', 'Noto Sans TC', monospace;
        }
        .control-label {
            @apply text-sm font-medium text-gray-600;
        }
        .value-display {
            @apply text-lg font-bold text-indigo-600;
        }
        .info-box {
            @apply bg-white p-6 rounded-xl shadow-md transition-all duration-300;
        }
        .control-button {
            @apply w-8 h-8 rounded-full bg-gray-200 text-gray-800 font-bold text-lg flex items-center justify-center hover:bg-gray-300 transition-colors duration-200 flex-shrink-0;
        }
        .number-input {
            @apply w-full text-center text-lg font-bold text-indigo-600 border-gray-300 rounded-md shadow-sm focus:border-indigo-400 focus:ring focus:ring-indigo-300 focus:ring-opacity-50;
        }
        .tab-button {
            @apply py-2 px-4 text-sm font-medium text-center text-gray-500 border-b-2 border-transparent hover:text-gray-700 hover:border-gray-300 focus:outline-none transition-colors duration-200;
        }
        .active-tab {
            @apply text-indigo-600 border-indigo-500;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div class="container mx-auto p-4 md:p-8 max-w-5xl">
        
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800">LMSR Interaction Simulator</h1>
            <p class="mt-2 text-md text-gray-600">Logarithmic Market Scoring Rule</p>
            <p class="mt-2 text-md text-gray-600">This is generated fully by Gemini</p>
        </header>

        <main class="grid grid-cols-1 md:grid-cols-3 gap-6">
            
            <!-- Controls Section -->
            <div class="md:col-span-1 space-y-6">
                <div class="info-box">
                    <h2 class="text-xl font-bold mb-4 border-b pb-2">Parameters</h2>
                    
                    <!-- Liquidity (b) Control -->
                    <div class="space-y-2">
                        <div class="flex justify-between items-center">
                            <label for="bSlider" class="control-label">Liquidity (b):</label>
                            <span id="bValue" class="value-display">100</span>
                        </div>
                        <p class="text-xs text-gray-500" style="font-family: 'Noto Sans TC', sans-serif;">b 值越高，市場深度越深，價格對交易量的敏感度越低。</p>
                        <div class="flex items-center space-x-3">
                            <button id="bDecrement" class="control-button">-</button>
                            <input id="bSlider" type="range" min="10" max="1000" value="100" step="10" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                            <button id="bIncrement" class="control-button">+</button>
                        </div>
                    </div>

                    <hr class="my-4">

                    <!-- Shares of Outcome A Control -->
                    <div class="space-y-2">
                        <label for="q1Input" class="control-label">Quantity (q_A):</label>
                        <div class="flex items-center space-x-3">
                            <button id="q1Decrement" class="control-button">-</button>
                            <input id="q1Input" type="number" value="0" step="1" class="number-input">
                            <button id="q1Increment" class="control-button">+</button>
                        </div>
                        <input id="q1Slider" type="range" min="-500" max="500" value="0" step="1" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer mt-2">
                    </div>
                    
                    <hr class="my-4">

                    <!-- Shares of Outcome B Control -->
                    <div class="space-y-2">
                        <label for="q2Input" class="control-label">Quantity (q_B):</label>
                        <div class="flex items-center space-x-3">
                            <button id="q2Decrement" class="control-button">-</button>
                            <input id="q2Input" type="number" value="0" step="1" class="number-input">
                            <button id="q2Increment" class="control-button">+</button>
                        </div>
                        <input id="q2Slider" type="range" min="-500" max="500" value="0" step="1" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer mt-2">
                    </div>

                    <hr class="my-4">

                    <!-- Chart Range Control -->
                    <div class="space-y-2">
                        <div class="flex justify-between items-center">
                            <label for="rangeSlider" class="control-label">Chart Range:</label>
                            <span id="rangeValue" class="value-display">200</span>
                        </div>
                        <div class="flex items-center space-x-3">
                            <button id="rangeDecrement" class="control-button">-</button>
                            <input id="rangeSlider" type="range" min="10" max="1000" value="200" step="10" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                            <button id="rangeIncrement" class="control-button">+</button>
                        </div>
                    </div>
                </div>

                <div class="info-box">
                    <h2 class="text-xl font-bold mb-4 border-b pb-2">Current State</h2>
                    <div class="space-y-3">
                        <div>
                            <p class="control-label">Price (p_A):</p>
                            <p id="price1" class="value-display">0.500</p>
                        </div>
                        <div>
                            <p class="control-label">Price (p_B):</p>
                            <p id="price2" class="value-display">0.500</p>
                        </div>
                        <div>
                            <p class="control-label">Total Cost (C):</p>
                            <p id="cost" class="value-display">69.31</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Chart and Formula Section -->
            <div class="md:col-span-2 space-y-6">
                <div class="info-box">
                    <div class="flex justify-between border-b border-gray-200 mb-4">
                        <button id="tabA" class="tab-button active-tab">Price Curve A</button>
                        <button id="tabB" class="tab-button">Price Curve B</button>
                        <button id="tabCombined" class="tab-button">Combined</button>
                    </div>
                    <canvas id="lmsrChart"></canvas>
                </div>
                
                <div class="info-box bg-indigo-50 border-l-4 border-indigo-400">
                    <h2 class="text-xl font-bold mb-4">Core Formulas</h2>
                    <div class="space-y-4 text-sm text-gray-700">
                        <p><strong>Cost Function:</strong></p>
                        <p class="bg-white p-3 rounded-lg text-center text-md">
                            <code class="font-mono">C(q) = b * ln(Σ exp(qᵢ / b))</code>
                        </p>
                        <p><strong>Price Function:</strong></p>
                        <p class="bg-white p-3 rounded-lg text-center text-md">
                            <code class="font-mono">pᵢ(q) = exp(qᵢ / b) / Σ exp(qⱼ / b)</code>
                        </p>
                    </div>
                </div>
            </div>
        </main>

    </div>

    <script>
        // --- State ---
        let activeChart = 'A'; // 'A', 'B', or 'Combined'

        // --- DOM Elements ---
        const bSlider = document.getElementById('bSlider');
        const q1Slider = document.getElementById('q1Slider');
        const q2Slider = document.getElementById('q2Slider');
        const rangeSlider = document.getElementById('rangeSlider');
        
        const bValue = document.getElementById('bValue');
        const q1Input = document.getElementById('q1Input');
        const q2Input = document.getElementById('q2Input');
        const rangeValue = document.getElementById('rangeValue');

        const price1Display = document.getElementById('price1');
        const price2Display = document.getElementById('price2');
        const costDisplay = document.getElementById('cost');

        const bDecrement = document.getElementById('bDecrement');
        const bIncrement = document.getElementById('bIncrement');
        const q1Decrement = document.getElementById('q1Decrement');
        const q1Increment = document.getElementById('q1Increment');
        const q2Decrement = document.getElementById('q2Decrement');
        const q2Increment = document.getElementById('q2Increment');
        const rangeDecrement = document.getElementById('rangeDecrement');
        const rangeIncrement = document.getElementById('rangeIncrement');

        const tabA = document.getElementById('tabA');
        const tabB = document.getElementById('tabB');
        const tabCombined = document.getElementById('tabCombined');

        const ctx = document.getElementById('lmsrChart').getContext('2d');
        let chart;

        // --- LMSR Core Functions ---
        function calculateCost(q1, q2, b) {
            return b * Math.log(Math.exp(q1 / b) + Math.exp(q2 / b));
        }

        function calculatePrices(q1, q2, b) {
            const exp_q1_b = Math.exp(q1 / b);
            const exp_q2_b = Math.exp(q2 / b);
            const denominator = exp_q1_b + exp_q2_b;
            const p1 = exp_q1_b / denominator;
            const p2 = exp_q2_b / denominator;
            return { p1, p2 };
        }

        // --- Charting Function ---
        function createOrUpdateChart() {
            const b = parseFloat(bSlider.value);
            const q1_base = parseFloat(q1Slider.value);
            const q2_base = parseFloat(q2Slider.value);
            const range = parseFloat(rangeSlider.value);

            // Dynamically adjust step to keep chart smooth but performant
            const step = Math.max(1, Math.round(range / 40));
            
            let datasets = [];
            let labels = [];
            let xAxisLabel = '';

            // Generate data for Price Curve A
            if (activeChart === 'A' || activeChart === 'Combined') {
                const priceDataA = [];
                const labelsA = [];
                 for (let i = -range; i <= range; i += step) {
                    const current_q1 = q1_base + i;
                    labelsA.push(current_q1);
                    const { p1 } = calculatePrices(current_q1, q2_base, b);
                    priceDataA.push(p1);
                }
                datasets.push({
                    label: 'Price of A (p_A)',
                    data: priceDataA,
                    borderColor: 'rgb(79, 70, 229)',
                    backgroundColor: 'rgba(79, 70, 229, 0.1)',
                    fill: activeChart !== 'Combined',
                    tension: 0.4,
                    pointRadius: 0,
                });
                if (activeChart === 'A') {
                    labels = labelsA;
                    xAxisLabel = 'Quantity (q_A)';
                }
            }

            // Generate data for Price Curve B
            if (activeChart === 'B') {
                const priceDataB = [];
                 for (let i = -range; i <= range; i += step) {
                    const current_q2 = q2_base + i;
                    labels.push(current_q2);
                    const { p2 } = calculatePrices(q1_base, current_q2, b);
                    priceDataB.push(p2);
                }
                datasets.push({
                    label: 'Price of B (p_B)',
                    data: priceDataB,
                    borderColor: 'rgb(219, 39, 119)',
                    backgroundColor: 'rgba(219, 39, 119, 0.1)',
                    fill: true,
                    tension: 0.4,
                    pointRadius: 0,
                });
                xAxisLabel = 'Quantity (q_B)';
            }
            
            // Generate data for B in Combined view (against q_A changes)
            if (activeChart === 'Combined') {
                const priceDataB_combined = [];
                // Use the same labels as curve A
                for (let i = -range; i <= range; i += step) {
                    const current_q1 = q1_base + i;
                    if(labels.length < (2 * range / step + 1)) labels.push(current_q1);
                    const { p2 } = calculatePrices(current_q1, q2_base, b);
                    priceDataB_combined.push(p2);
                }
                 datasets.push({
                    label: 'Price of B (p_B)',
                    data: priceDataB_combined,
                    borderColor: 'rgb(219, 39, 119)',
                    backgroundColor: 'rgba(219, 39, 119, 0.1)',
                    fill: false,
                    tension: 0.4,
                    pointRadius: 0,
                });
                xAxisLabel = 'Quantity (q_A)';
            }

            const data = {
                labels: labels,
                datasets: datasets
            };

            if (chart) {
                chart.data = data;
                chart.options.scales.x.title.text = xAxisLabel;
                chart.update('none');
            } else {
                chart = new Chart(ctx, {
                    type: 'line',
                    data: data,
                    options: {
                        animation: false,
                        responsive: true,
                        maintainAspectRatio: true,
                        scales: {
                            y: { beginAtZero: true, max: 1.0, title: { display: true, text: 'Price' } },
                            x: { title: { display: true, text: xAxisLabel } }
                        },
                        plugins: {
                            tooltip: { mode: 'index', intersect: false },
                        }
                    }
                });
            }
        }

        // --- Main Update Function ---
        function update() {
            const b = parseFloat(bSlider.value);
            const q1 = parseFloat(q1Slider.value);
            const q2 = parseFloat(q2Slider.value);
            const range = parseFloat(rangeSlider.value);

            bValue.textContent = b;
            q1Input.value = q1;
            q2Input.value = q2;
            rangeValue.textContent = range;

            const { p1, p2 } = calculatePrices(q1, q2, b);
            const cost = calculateCost(q1, q2, b);

            price1Display.textContent = p1.toFixed(3);
            price2Display.textContent = p2.toFixed(3);
            costDisplay.textContent = cost.toFixed(2);
            
            createOrUpdateChart();
        }

        // --- Event Listeners ---
        bSlider.addEventListener('input', update);
        q1Slider.addEventListener('input', update);
        q2Slider.addEventListener('input', update);
        rangeSlider.addEventListener('input', update);

        q1Input.addEventListener('input', () => {
            const val = parseInt(q1Input.value);
            if (!isNaN(val) && val >= q1Slider.min && val <= q1Slider.max) {
                q1Slider.value = val;
                update();
            }
        });
        q2Input.addEventListener('input', () => {
            const val = parseInt(q2Input.value);
            if (!isNaN(val) && val >= q2Slider.min && val <= q2Slider.max) {
                q2Slider.value = val;
                update();
            }
        });

        bDecrement.addEventListener('click', () => { bSlider.stepDown(); update(); });
        bIncrement.addEventListener('click', () => { bSlider.stepUp(); update(); });
        q1Decrement.addEventListener('click', () => { q1Slider.stepDown(); update(); });
        q1Increment.addEventListener('click', () => { q1Slider.stepUp(); update(); });
        q2Decrement.addEventListener('click', () => { q2Slider.stepDown(); update(); });
        q2Increment.addEventListener('click', () => { q2Slider.stepUp(); update(); });
        rangeDecrement.addEventListener('click', () => { rangeSlider.stepDown(); update(); });
        rangeIncrement.addEventListener('click', () => { rangeSlider.stepUp(); update(); });

        // Tab Listeners
        function setActiveTab(tabName) {
            activeChart = tabName;
            tabA.classList.toggle('active-tab', tabName === 'A');
            tabB.classList.toggle('active-tab', tabName === 'B');
            tabCombined.classList.toggle('active-tab', tabName === 'Combined');
            createOrUpdateChart();
        }

        tabA.addEventListener('click', () => setActiveTab('A'));
        tabB.addEventListener('click', () => setActiveTab('B'));
        tabCombined.addEventListener('click', () => setActiveTab('Combined'));

        // --- Initial Load ---
        window.onload = update;

    </script>
</body>
</html>

